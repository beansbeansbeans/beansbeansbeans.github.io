<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<title>Web Audio API createMediaSourceElement() Example</title>
<style>
html, body {
  height: 100%;
  overflow: hidden;
  margin: 0;
  padding: 0;
}
</style>
</head>
<body>

<div id="myaudio"></div>

<div>
  <canvas id="fft" class="fft" width="512" height="200"></canvas>
</div>
<script>

(function() {
  var canvas = document.getElementById('fft');
  var ctx = canvas.getContext('2d');
  canvas.width = document.body.clientWidth / 1.4;

  const CANVAS_HEIGHT = canvas.height;
  const CANVAS_WIDTH = canvas.width;

  window.audio = new Audio();
  audio.src = 'test.ogg';
  audio.controls = true;

  document.querySelector('#myaudio').appendChild(audio);

  var context = new webkitAudioContext();
  var analyser = context.createAnalyser();

  function rafCallback() {
    var freqByteData = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(freqByteData);

    var SPACER_WIDTH = 10;
    var BAR_WIDTH = 5;
    var OFFSET = 100;
    var CUTOFF = 23;
    var numBars = Math.round(CANVAS_WIDTH / SPACER_WIDTH);

    ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    ctx.fillStyle = '#F6D565';

    for (var i = 0; i < numBars; ++i) {
      var magnitude = freqByteData[i + OFFSET];
      ctx.fillRect(i * SPACER_WIDTH, CANVAS_HEIGHT, BAR_WIDTH, -magnitude);
    }

    window.webkitRequestAnimationFrame(rafCallback);
  }

  function onLoad(e) {
    var source = context.createMediaElementSource(audio);
    source.connect(analyser);
    analyser.connect(context.destination);

    rafCallback();
  }

  window.addEventListener('load', onLoad, false);
})();
</script>
</body>
</html>